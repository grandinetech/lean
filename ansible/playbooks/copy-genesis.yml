---
# Copy Genesis Files: Copy locally generated genesis files to remote hosts
# 
# Prerequisites: Genesis files must be generated first using one of:
#   - ./generate-genesis.sh <genesis-dir> --mode ansible
#   - ansible-playbook playbooks/generate-genesis.yml -e "genesis_dir=<path>"
#   - ansible-playbook playbooks/site.yml (runs generate-genesis automatically)
#
# This playbook validates all required files exist locally before copying.

- name: Copy Genesis Files to Remote Hosts
  hosts: all:!local
  gather_facts: yes
  vars:
    validator_config_file: "{{ genesis_dir }}/validator-config.yaml"
    # Use remote_genesis_dir from group_vars, or default to standard remote path
    actual_remote_genesis_dir: "{{ remote_genesis_dir | default('/opt/lean-quickstart/genesis') }}"

  pre_tasks:
    - name: Add localhost to inventory for fact sharing
      add_host:
        name: localhost
        groups: localhost_group
      when: "'localhost' not in groups['all']"
      run_once: true

    - name: Validate local genesis directory exists
      stat:
        path: "{{ genesis_dir }}"
      register: genesis_dir_stat
      delegate_to: localhost
      run_once: true

    - name: Fail if local genesis directory is missing
      fail:
        msg: "Local genesis directory not found at {{ genesis_dir }}. Please run generate-genesis.sh first."
      when: not genesis_dir_stat.stat.exists
      delegate_to: localhost
      run_once: true

    - name: Check required genesis files exist locally
      stat:
        path: "{{ genesis_dir }}/{{ item }}"
      register: genesis_file_stat
      delegate_to: localhost
      run_once: true
      loop:
        - config.yaml
        - validators.yaml
        - annotated_validators.yaml
        - nodes.yaml
        - genesis.json
        - genesis.ssz
        - validator-config.yaml

    - name: Fail if required genesis files are missing
      fail:
        msg: "Required genesis file {{ item.item }} not found in {{ genesis_dir }}. Please run generate-genesis.sh first."
      loop: "{{ genesis_file_stat.results }}"
      when: not item.stat.exists
      delegate_to: localhost
      run_once: true

    - name: Check if hash-sig-keys directory exists locally
      stat:
        path: "{{ genesis_dir }}/hash-sig-keys"
      register: hash_sig_keys_stat
      delegate_to: localhost
      run_once: true

    - name: Extract all node names from validator-config.yaml
      shell: |
        yq eval '.validators[].name' "{{ genesis_dir }}/validator-config.yaml"
      register: all_node_names_raw
      delegate_to: localhost
      run_once: true
      changed_when: false

    - name: Set all node names list
      set_fact:
        all_node_names: "{{ all_node_names_raw.stdout_lines }}"
      delegate_to: localhost
      run_once: true

    - name: Check each node key file exists locally
      stat:
        path: "{{ genesis_dir }}/{{ item }}.key"
      register: node_key_stats
      delegate_to: localhost
      run_once: true
      loop: "{{ all_node_names }}"

    - name: Identify missing key files
      set_fact:
        missing_key_files: "{{ node_key_stats.results | selectattr('stat.exists', 'equalto', false) | map(attribute='item') | list }}"
      delegate_to: localhost
      run_once: true

    - name: Fail if any node key files are missing
      fail:
        msg: |
          ❌ Missing .key files for nodes: {{ missing_key_files | join(', ') }}
          
          Expected files:
          {% for node in missing_key_files %}
            - {{ genesis_dir }}/{{ node }}.key
          {% endfor %}
          
          Please run generate-genesis.sh first to create the key files:
            ./generate-genesis.sh {{ genesis_dir }} --mode ansible
            
          Or run the full deployment with site.yml which generates genesis automatically:
            ansible-playbook playbooks/site.yml -e "genesis_dir={{ genesis_dir }}" -e "node_names=all"
      when: missing_key_files | length > 0
      delegate_to: localhost
      run_once: true

    - name: Confirm all key files are present
      debug:
        msg: "✅ All {{ all_node_names | length }} key file(s) are present and ready to copy: {{ all_node_names | join(', ') }}"
      delegate_to: localhost
      run_once: true

  tasks:
    - name: Create remote genesis directory
      file:
        path: "{{ actual_remote_genesis_dir }}"
        state: directory
        mode: '0755'

    - name: Copy genesis config files to remote host
      copy:
        src: "{{ genesis_dir }}/{{ item }}"
        dest: "{{ actual_remote_genesis_dir }}/{{ item }}"
        mode: '0644'
        force: yes
      loop:
        - config.yaml
        - validators.yaml
        - annotated_validators.yaml
        - nodes.yaml
        - genesis.json
        - genesis.ssz
        - validator-config.yaml

    - name: Copy node private key files to remote host
      copy:
        src: "{{ genesis_dir }}/{{ item }}.key"
        dest: "{{ actual_remote_genesis_dir }}/{{ item }}.key"
        mode: '0600'
        force: yes
      loop: "{{ all_node_names }}"
      loop_control:
        label: "{{ item }}.key"

    - name: Create hash-sig-keys directory on remote
      file:
        path: "{{ actual_remote_genesis_dir }}/hash-sig-keys"
        state: directory
        mode: '0755'
      when: hash_sig_keys_stat.stat.exists

    - name: Copy hash-sig-keys directory to remote host
      copy:
        src: "{{ genesis_dir }}/hash-sig-keys/"
        dest: "{{ actual_remote_genesis_dir }}/hash-sig-keys/"
        mode: '0644'
        force: yes
      when: hash_sig_keys_stat.stat.exists

    - name: List files on remote genesis directory
      find:
        paths: "{{ actual_remote_genesis_dir }}"
        recurse: yes
        file_type: file
      register: remote_files

    - name: Display copied files summary
      debug:
        msg: |
          ✅ Genesis directory copied successfully!
          
          Source: {{ genesis_dir }}/
          Destination: {{ actual_remote_genesis_dir }}/
          Remote host: {{ inventory_hostname }}
          
          Files copied: {{ remote_files.files | length }}
          {% for f in remote_files.files[:15] %}
            - {{ f.path | replace(actual_remote_genesis_dir + '/', '') }}
          {% endfor %}
          {% if remote_files.files | length > 15 %}
            ... and {{ remote_files.files | length - 15 }} more files
          {% endif %}

