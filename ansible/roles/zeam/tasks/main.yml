---
# Zeam role: Deploy and manage Zeam nodes
# Converts client-cmds/zeam-cmd.sh logic to Ansible tasks

- name: Extract docker image from client-cmd.sh
  shell: |
    # Extract the docker image from node_docker line (find word containing / and :)
    # playbook_dir points to ansible/playbooks, go up two levels to reach project root
    project_root="$(cd '{{ playbook_dir }}/../..' && pwd)"
    script_path="$project_root/client-cmds/zeam-cmd.sh"
    if [ ! -f "$script_path" ]; then
      echo "ERROR: Script not found at $script_path (project_root=$project_root, playbook_dir={{ playbook_dir }})" >&2
      exit 1
    fi
    grep -E '^node_docker=' "$script_path" | head -1 | grep -oE '[a-zA-Z0-9._-]+/[a-zA-Z0-9._-]+:[a-zA-Z0-9._-]+' | head -1
  register: zeam_docker_image_raw
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Extract deployment mode from client-cmd.sh
  shell: |
    # Extract the value from node_setup line
    # playbook_dir points to ansible/playbooks, go up two levels to reach project root
    project_root="$(cd '{{ playbook_dir }}/../..' && pwd)"
    grep -E '^node_setup=' "$project_root/client-cmds/zeam-cmd.sh" | head -1 | sed -E 's/.*node_setup="([^"]+)".*/\1/'
  register: zeam_deployment_mode_raw
  changed_when: false
  delegate_to: localhost
  run_once: true

- name: Set docker image and deployment mode from client-cmd.sh
  set_fact:
    zeam_docker_image: "{{ zeam_docker_image_raw.stdout | trim | default('blockblaz/zeam:latest') }}"
    deployment_mode: "{{ zeam_deployment_mode_raw.stdout | trim | default('docker') }}"
  delegate_to: localhost
  run_once: true

- name: Extract node configuration from validator-config.yaml
  shell: |
    yq eval ".validators[] | select(.name == \"{{ node_name }}\") | .{{ item }}" "{{ genesis_dir }}/validator-config.yaml"
  register: node_config
  changed_when: false
  loop:
    - metricsPort
    - privkey
  when: node_name is defined

- name: Set node metrics port
  set_fact:
    zeam_metrics_port: "{{ node_config.results[0].stdout }}"
  when: node_config is defined

- name: Ensure node key file exists
  stat:
    path: "{{ genesis_dir }}/{{ node_name }}.key"
  register: node_key_stat

- name: Debug node key file check
  debug:
    msg: "Checking for key file at {{ genesis_dir }}/{{ node_name }}.key - exists: {{ node_key_stat.stat.exists | default('undefined') }}"

- name: Fail if node key file is missing
  fail:
    msg: "Node key file {{ node_name }}.key not found in {{ genesis_dir }}"
  when: not (node_key_stat.stat.exists | default(false))

- name: Create node data directory
  file:
    path: "{{ data_dir }}/{{ node_name }}"
    state: directory
    mode: '0755'

- name: Set validator config value
  set_fact:
    actual_validator_config: "{{ validator_config if validator_config is defined and validator_config != '' else 'genesis_bootnode' }}"

- name: Deploy Zeam node using Docker
  block:
    - name: Stop existing Zeam container (if any)
      command: docker rm -f {{ node_name }}
      register: docker_stop_result
      failed_when: false
      changed_when: docker_stop_result.rc == 0

    - name: Start Zeam container
      # TODO: Remove --platform linux/amd64 when blockblaz/zeam:latest multi-platform image is available on Docker Hub
      # Multi-platform support is being added in zeam CI (see .github/workflows/ci.yml docker-build-multiarch job)
      command: >-
        docker run -d
        --pull=always
        --platform linux/amd64
        --name {{ node_name }}
        --restart unless-stopped
        --network host
        --security-opt seccomp=unconfined
        -v {{ genesis_dir }}:/config:ro
        -v {{ data_dir }}/{{ node_name }}:/data
        {{ zeam_docker_image }}
        node
        --custom_genesis /config
        --validator_config {{ actual_validator_config }}
        --data-dir /data
        --node-id {{ node_name }}
        --node-key /config/{{ node_name }}.key
        --metrics_enable
        --api-port {{ zeam_metrics_port }}
      register: zeam_container_result
      changed_when: zeam_container_result.rc == 0

- name: Deploy Zeam node using binary
  block:
    - name: Check if binary exists
      stat:
        path: "{{ zeam_binary_path }}"
      register: binary_stat

    - name: Fail if binary not found
      fail:
        msg: "Zeam binary not found at {{ zeam_binary_path }}"
      when: not binary_stat.stat.exists

    - name: Create systemd service for Zeam
      template:
        src: zeam.service.j2
        dest: "/etc/systemd/system/zeam-{{ node_name }}.service"
        mode: '0644'
      become: yes
      when: ansible_connection != 'local'

    - name: Start and enable Zeam service
      systemd:
        name: "zeam-{{ node_name }}"
        state: started
        enabled: yes
        daemon_reload: yes
      become: yes
      when: ansible_connection != 'local'
  when: deployment_mode == 'binary'
