---
# Common role: Install dependencies and setup directories
# Handles Docker, yq, and directory creation

- name: Check if running on localhost
  set_fact:
    is_localhost: "{{ ansible_connection == 'local' }}"
  when: ansible_connection is defined

- name: Install system dependencies (non-localhost)
  package:
    name:
      - python3
      - python3-pip
      - curl
    state: present
  become: yes
  when: not is_localhost | default(false)

- name: Check if Docker is installed
  command: which docker
  register: docker_check
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Install Docker (non-localhost)
  block:
    - name: Add Docker GPG key
      apt_key:
        url: https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg
        state: present
      become: yes
      when: ansible_os_family == "Debian"

    - name: Add Docker repository
      apt_repository:
        repo: "deb [arch={{ ansible_architecture }}] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable"
        state: present
      become: yes
      when: ansible_os_family == "Debian"

    - name: Install Docker packages
      package:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
        state: present
      become: yes

    - name: Start and enable Docker service
      systemd:
        name: docker
        state: started
        enabled: yes
      become: yes
  when: not is_localhost | default(false) and docker_check.rc != 0

- name: Check if yq is installed
  command: which yq
  register: yq_check
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Install yq (non-localhost)
  block:
    - name: Detect architecture for yq
      set_fact:
        yq_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else ('arm64' if ansible_architecture in ['aarch64', 'arm64'] else 'amd64') }}"
      when: ansible_os_family in ["Linux", "Debian", "RedHat"]

    - name: Download yq binary (Linux/Debian/RedHat)
      block:
        - name: Download yq
          get_url:
            url: "https://github.com/mikefarah/yq/releases/latest/download/yq_linux_{{ yq_arch | default('amd64') }}"
            dest: /tmp/yq
            mode: '0755'
          register: yq_download_result

        - name: Move yq to /usr/local/bin
          copy:
            src: /tmp/yq
            dest: /usr/local/bin/yq
            mode: '0755'
            remote_src: yes
          when: yq_download_result is succeeded
      become: yes
      when: 
        - ansible_os_family in ["Linux", "Debian", "RedHat"]
        - yq_check.rc != 0
      ignore_errors: true

    - name: Install yq via Homebrew (macOS)
      homebrew:
        name: yq
        state: present
      when: ansible_os_family == "Darwin" and yq_check.rc != 0
  when: not is_localhost | default(false) and yq_check.rc != 0

- name: Verify Docker is available
  command: docker --version
  register: docker_version
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Fail if Docker is not available
  fail:
    msg: "Docker is required but not installed. Please install Docker first."
  when: docker_version.rc != 0

- name: Verify yq is available
  command: yq --version
  register: yq_version
  changed_when: false
  failed_when: false
  ignore_errors: true

- name: Fail if yq is not available
  fail:
    msg: "yq is required but not installed. Install on macOS: brew install yq, or see https://github.com/mikefarah/yq"
  when: yq_version.rc != 0

- name: Create network directory structure
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - "{{ network_dir }}"
    - "{{ genesis_dir }}"
    - "{{ data_dir }}"
  when: network_dir is defined

- name: Ensure node_names is a list
  set_fact:
    node_names_list: "{{ (node_names | default([]) | type_debug == 'list' and node_names) or (node_names | default([]) | type_debug == 'str' and [node_names]) or [] }}"

- name: Create data directories for each node
  file:
    path: "{{ data_dir }}/{{ item }}"
    state: directory
    mode: '0755'
  loop: "{{ node_names_list }}"
  when: node_names_list | length > 0

